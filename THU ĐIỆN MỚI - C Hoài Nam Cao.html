<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>Thu ti·ªÅn ƒëi·ªán</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; max-width: 800px; margin:auto; padding:20px; border-radius:10px; }
    input, button, textarea { margin: 5px; padding: 5px; font-size: 14px; }
    .input-group { display: flex; align-items: center; margin-bottom: 10px; }
    .input-group label { width: 150px; font-weight: bold; }
    .input-group input { flex: 1; }
    #hoaDon { width: 400px; min-height: 250px; border: 2px solid black; padding: 15px; white-space: normal; font-size: 18px; font-family: 'Times New Roman', serif; line-height: 1.2; }
    #hoaDon p { margin: 10px 0; }
    #lichSuIn { width: 100%; height: 120px; font-size: 14px; white-space: nowrap; overflow-x: auto; }
    #lichSuThu { width: 250px; height: 150px; }
    #inButton { padding: 12px 24px; font-size: 18px; font-weight: bold; background-color: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; }
    #inButton:hover { background-color: #45a049; }
    @media print { body * { visibility: hidden; } #hoaDon, #hoaDon * { visibility: visible; } #hoaDon { position: absolute; top: 0; left: 0; width: 100%; } }
  </style>
</head>
<body>

<h2>Thu ti·ªÅn ƒëi·ªán</h2>
<div class="row">
  <button onclick="document.getElementById('fileInput').click()">ƒê·∫©y d·ªØ li·ªáu</button>
  <input type="file" id="fileInput" accept=".xlsx" style="display:none" onchange="docFileExcel(event)" />
</div>
<div class="input-group" style="gap:10px;">
  <div style="flex:1; display:flex; align-items:center;">
    <label style="width:120px;">Ng∆∞·ªùi thu ti·ªÅn</label>
    <input id="nguoiThuTien" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu"/>
  </div>
  <div style="flex:1; display:flex; align-items:center;">
    <label style="width:120px;">Ti√™u ƒë·ªÅ</label>
    <input id="tieuDe" placeholder="Ti·ªÅn ƒêi·ªán Th√°ng"/>
  </div>
</div>
<div class="input-group">
  <label>M√£ kh√°ch h√†ng</label>
  <input id="maKH" list="danhSachKH" onkeydown="if(event.key==='Enter'){timKiemMaKH()}" placeholder="(m·ª•c t√¨m ki·∫øm)"/>
  <datalist id="danhSachKH"></datalist>
  <button onclick="timKiemMaKH()">üîç</button>
</div>
<div class="input-group">
  <label>S·ªë ti·ªÅn</label>
  <input id="soTien" readonly/>
</div>
<div class="input-group">
  <label>T√™n KH</label>
  <input id="tenKH" readonly/>
</div>
<div style="display:flex; gap:10px; align-items:flex-start; margin-top:10px;">
  <div style="flex:1;">
    <div id="hoaDon">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
  </div>
  <div style="display:flex; flex-direction:column; gap:10px;">
    <button id="inButton" onclick="inHoaDon()">In</button>
    <label><b>L·ªãch s·ª≠ thu</b></label>
    <textarea id="lichSuThu" readonly></textarea>
    <button onclick="xuatLichSu('thu')">Xu·∫•t l·ªãch s·ª≠</button>
  </div>
</div>
<div class="row">
  <label>L·ªãch s·ª≠ in</label><br/>
  <textarea id="lichSuIn" readonly></textarea><br/>
  <button onclick="xuatLichSu('in')">Xu·∫•t l·ªãch s·ª≠</button>
</div>
<button onclick="xuatLichSuExcel()">Xu·∫•t Excel</button>
<button onclick="xoaLichSu()">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>

<script>
const bangGiaDien = [
  { sanLuong: 55, donGia: 1984 },
  { sanLuong: 52, donGia: 2050 },
  { sanLuong: 103, donGia: 2380 },
  { sanLuong: 103, donGia: 2998 },
  { sanLuong: 103, donGia: 3350 },
  { sanLuong: 287, donGia: 3460 }
];

function tinhSanLuongTuSoTien(soTien) {
  let tongSanLuong = 0;
  let tienConLai = soTien;
  for (let i = 0; i < bangGiaDien.length; i++) {
    const bac = bangGiaDien[i];
    const tienBac = bac.sanLuong * bac.donGia;
    if (tienConLai >= tienBac) {
      tongSanLuong += bac.sanLuong;
      tienConLai -= tienBac;
    } else {
      const sanLuongConLai = Math.floor(tienConLai / bac.donGia);
      tongSanLuong += sanLuongConLai;
      break;
    }
  }
  return tongSanLuong;
}

let duLieu = [];
let lichSuIn = JSON.parse(localStorage.getItem("lichSuIn")) || [];
let lichSuThu = JSON.parse(localStorage.getItem("lichSuThu")) || [];
function formatVND(number) { return Number(number).toLocaleString('vi-VN') + ' ‚Ç´'; }

function timKiemMaKH() {
  const maKH = document.getElementById("maKH").value.trim();
  // l·ªçc t·∫•t c·∫£ c√°c d√≤ng c√≥ m√£ kh·ªõp
  const ketQua = duLieu.filter(row => String(row.MA_KHTT).trim() === maKH);
  
  if (ketQua.length > 0) {
    // l·∫•y d√≤ng ƒë·∫ßu ti√™n ƒë√∫ng m√£ KH
    const kh = ketQua[0];
    document.getElementById("tenKH").value = kh.TEN_KHTT;
    document.getElementById("soTien").value = kh.TONG_NOP;

    const sanLuong = tinhSanLuongTuSoTien(Number(kh.TONG_NOP));
    hienThiHoaDon(kh.MA_KHTT, kh.TEN_KHTT, kh.TONG_NOP, sanLuong);

    const soTien = Number(kh.TONG_NOP) + 2000;
    const thoiGian = new Date().toLocaleString();
    lichSuThu.push({ maKH: kh.MA_KHTT, tenKH: kh.TEN_KHTT, soTien, thoiGian });
    localStorage.setItem("lichSuThu", JSON.stringify(lichSuThu));
    capNhatLichSu();
  } else {
    document.getElementById("hoaDon").innerText = "[Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng]";
  }
}
function hienThiHoaDon(maKH, tenKH, soTien, sanLuong) {
  const nguoiThu = document.getElementById("nguoiThuTien").value || "-";
  const tieuDe = document.getElementById("tieuDe").value || "Ti·ªÅn ƒêi·ªán Th√°ng";
  const phi = 2000;
  const tong = Number(soTien) + phi;
  const now = new Date();
  const ngay = now.toLocaleDateString('vi-VN');
  const gio = now.toTimeString().split(' ')[0];
  const thoiGian = `Ng√†y ${ngay}, Gi·ªù ${gio}`;
  const noiDung = `
    <div style="text-align:center; font-weight:bold;">${tieuDe}</div>

    <div style="text-align:center; font-weight:bold;">BI√äN LAI NH·∫¨N TI·ªÄN CHUY·ªÇN KHO·∫¢N</div>

    <p>M√£ KH: ${maKH}</p>

    <p>T√™n KH: ${tenKH}</p>

    <p>∆Ø·ªõc t√≠nh s·∫£n l∆∞·ª£ng: ${sanLuong} kWh</p>

    <p>Ph√≠: ${formatVND(phi)}</p>

    <p>T·ªïng Ti·ªÅn: ${formatVND(tong)}</p>

    <p>Ng∆∞·ªùi thu ti·ªÅn: ${nguoiThu}</p>

    <div style="text-align:center; font-weight:bold;">ƒê√É NH·∫¨N TI·ªÄN</div>

    <p>${thoiGian}</p>

    <div id="maQR" style="text-align:center; margin-top:10px;"></div>
  `;
  document.getElementById("hoaDon").innerHTML = noiDung.trim();

  const barcodeContainer = document.getElementById("maQR");
  barcodeContainer.innerHTML = '';
  new QRCode(barcodeContainer, {
    text: maKH,
    width: 100,
    height: 100
  });
}

function inHoaDon() {
  const maKH = document.getElementById("maKH").value.trim();
  const tenKH = document.getElementById("tenKH").value.trim();
  const soTien = Number(document.getElementById("soTien").value || 0);
  if (!maKH || !tenKH || !soTien) {
    alert("‚ö†Ô∏è B·∫°n c·∫ßn t√¨m ƒë√∫ng m√£ KH tr∆∞·ªõc khi in!");
    return;
  }

  const sanLuong = tinhSanLuongTuSoTien(soTien);
  hienThiHoaDon(maKH, tenKH, soTien, sanLuong);

  const tong = soTien + 2000;
  const thoiGian = new Date().toLocaleString();

  // Ghi l·ªãch s·ª≠ ngay l·∫≠p t·ª©c tr∆∞·ªõc khi in
  lichSuIn.push({ maKH, tenKH, soTien: tong, thoiGian });
  lichSuThu.push({ maKH, tenKH, soTien: tong, thoiGian });

  // ƒê·∫£m b·∫£o l∆∞u ·ªïn ƒë·ªãnh
  localStorage.setItem("lichSuIn", JSON.stringify(lichSuIn));
  localStorage.setItem("lichSuThu", JSON.stringify(lichSuThu));

  // C·∫≠p nh·∫≠t giao di·ªán tr∆∞·ªõc khi in
  capNhatLichSu();

  // Ch·ªù 500ms ƒë·ªÉ l∆∞u ho√†n t·∫•t r·ªìi m·ªõi in
  setTimeout(() => {
    window.print();
  }, 500);
}

function capNhatLichSu() {
  const inText = lichSuIn.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
  const thuText = lichSuThu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
  document.getElementById("lichSuIn").value = inText;
  document.getElementById("lichSuThu").value = thuText;
}

function xuatLichSu(loai) {
  const duLieu = loai === 'in' ? lichSuIn : lichSuThu;
  const text = duLieu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${item.soTien}`).join("\n");
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `lich_su_${loai}.txt`;
  a.click();
}

function xuatLichSuExcel() {
  const wb = XLSX.utils.book_new();
  const wsIn = XLSX.utils.json_to_sheet(lichSuIn);
  XLSX.utils.book_append_sheet(wb, wsIn, "L·ªãch S·ª≠ In");
  const wsThu = XLSX.utils.json_to_sheet(lichSuThu);
  XLSX.utils.book_append_sheet(wb, wsThu, "L·ªãch S·ª≠ Thu");
  XLSX.writeFile(wb, "lich_su.xlsx");
}

function docFileExcel(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    duLieu = XLSX.utils.sheet_to_json(sheet);

    // Chu·∫©n h√≥a d·ªØ li·ªáu ngay khi load
    duLieu = duLieu.map(row => {
      return {
        MA_KHTT: String(row.MA_KHTT || "").trim().toUpperCase().replace(/(\.0)$/, ""),
        TEN_KHTT: String(row.TEN_KHTT || "").trim(),
        TONG_NOP: String(row.TONG_NOP || "").replace(/[^0-9]/g, "")  // ch·ªâ gi·ªØ s·ªë
      };
    });

    // Load l·∫°i danh s√°ch ch·ªçn
    const dataList = document.getElementById("danhSachKH");
    dataList.innerHTML = "";
    duLieu.forEach(row => {
      const option = document.createElement("option");
      option.value = row.MA_KHTT;
      dataList.appendChild(option);
    });
    alert("ƒê·∫©y d·ªØ li·ªáu th√†nh c√¥ng!");
    console.log("D·ªØ li·ªáu ƒë√£ chu·∫©n h√≥a:", duLieu);
  };
  reader.readAsArrayBuffer(file);
}

function xoaLichSu() {
  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ kh√¥ng?")) {
    localStorage.removeItem("lichSuIn");
    localStorage.removeItem("lichSuThu");
    lichSuIn = [];
    lichSuThu = [];
    capNhatLichSu();
  }
}
window.onload = capNhatLichSu;
</script>
</body>
</html>
